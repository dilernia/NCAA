---
title: "üèÄ March Madness Dashboard üèÄ"
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bg: "white"
      fg: "black" 
      primary: "#065cb5"
      navbar-bg: "black"
      base_font: 
        google: Passion One
      heading_font:
        google: Passion One
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: Satisfy
          local: false
    orientation: rows
    vertical_layout: fill
---

<style>
.navbar-brand {
  font-size: 28px;
}
.chart-title {  /* chart_title  */
   font-size: 28px;
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(showtext) # for custom Google fonts
library(wordcloud2) 
library(tidytext)
library(reactablefmtr)
library(flexdashboard)
library(flextable)
library(plotly)
library(downloadthis)

set.seed(1994)

# Plotting parameters
fontFamily <- "Passion One" # update base_font and heading_font in the YAML as well
textSize <- 20

# Downloading Google fonts for plots
font_add_google(name = str_to_title(fontFamily), 
                family = fontFamily)
```

```{r, include = FALSE, eval = TRUE}
library(showtext)
library(tidyverse)
library(png)

showtext_auto()

womens <- FALSE
tourneyYear <- 2023

# Setting working directory
setwd(paste0("H:/My Drive/dilerand@mail.gvsu.edu 2022-11-21 21 19/Other/Fun/March Madness/", tourneyYear))

# Setting file paths
stageDir <- paste0("march-machine-learning-mania-", tourneyYear, "/")

# This person did it with ggplot: https://stackoverflow.com/questions/16290052/march-madness-brackets-with-ggplot2

# Function for creatin bracket
bracketDraw <- function(submission, seeds, teams, logo = NULL, lineColor = "black", 
                        fontFamily = "Passion One", textSize = 6, retData = FALSE) {
  
  ### Helper functions
  first_evens <- function(x) {seq(from=2,to=2*x,length.out=x)}
  first_odds <- function(x) {seq(from=1,to=2*x-1,length.out=x)}
  
  ### calculate y-values for horizontal lines:
  ### this is for top-left corner of the bracket,
  ### but multiplying sequences by -1 makes these 
  ### values work for bottom right and left corners;
  ### final round has teams at y=2*off.set
  
  r1.y.width <- 1.5*strheight(s="Virginia Common",units="in") # this effects the width of the first round
  r1.y.offset <- 0.125*r1.y.width # this effects distance from y=0
  
  r1.y <- seq(from=r1.y.offset,to=r1.y.offset+r1.y.width,length.out=16)
  r2.y <- seq(from=mean(r1.y[1:2]),to=mean(r1.y[15:16]),length.out=8)
  r3.y <- seq(from=mean(r2.y[1:2]),to=mean(r2.y[7:8]),length.out=4)
  r4.y <- seq(from=mean(r3.y[1:2]),to=mean(r3.y[3:4]),length.out=2)
  r5.y <- seq(from=mean(r4.y[1:2]),to=mean(r4.y[1:2]),length.out=1)
  r6.y <- 1.5*r1.y.offset
  
  ### calculate horizontal bar start and stop coordinates
  ### note that there are 6 total rounds -- 5 rounds per quadrant
  r1.x.width <- 1.25*strwidth("Viriginia Commonwealth","inches") # how long should horizontal lines be?
  r1.x.offset <- 1
  round.break.points <- -(seq(from=0,to=7*r1.x.width,by=r1.x.width)+r1.x.offset)
  
  r1.x <- round.break.points[7:6]
  r2.x <- round.break.points[6:5]
  r3.x <- round.break.points[5:4]
  r4.x <- round.break.points[4:3]
  r5.x <- round.break.points[3:2]
  r6.x <- round.break.points[2:1]
  
  ### calculate verticals line coordinates: these are based off of
  ### r1.y values. Round 5 verticals need to connect the four subtrees
  ### via the top-left <-> bottom-left and top-right <-> bottom-right
  
  r1.verticals.start <- r1.y[first_odds(8)]
  r1.verticals.stop <- r1.y[first_evens(8)]
  
  r2.verticals.start <- r2.y[first_odds(4)]
  r2.verticals.stop <- r2.y[first_evens(4)]
  
  r3.verticals.start <- r3.y[first_odds(2)]
  r3.verticals.stop <- r3.y[first_evens(2)]
  
  r4.verticals.start <- r4.y[first_odds(1)]
  r4.verticals.stop <- r4.y[first_evens(1)]
  
  r5.verticals.start <- r5.y[1]
  r5.verticals.stop <- -r5.y[1]
  
  empty.bracket <- ggplot() + theme_bw() + theme(axis.line=element_blank(), axis.text.x=element_blank(), axis.text.y=element_blank(), axis.ticks=element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(), panel.border=element_blank(), panel.grid.major.x=element_blank(), panel.grid.minor.x=element_blank(), panel.grid.major.y=element_blank(), panel.grid.minor.y=element_blank(), plot.margin=unit(c(0,0,-6,-6),"mm"), text=element_text(size=12,hjust=0,vjust=0)) + coord_cartesian(ylim = c(-1.05*r1.y[16],1.05*r1.y[16]), xlim = c(1.025*r1.x[1],-1.025*r1.x[1]))
  
  vec1x <- c(1, 1, -1, -1)
  vec1y <- c(1, -1, 1, -1)
  vec11 <- c(1, -1)
  
  lineCoords <- list()
  
  lineCoords$R1 <- tibble(x = c(rep(as.numeric(vec1x %o% r1.x[1]), each = 16),
                                rep(as.numeric(vec1x %o% r1.x[2]), each = 8)),
                          y = c(as.numeric(r1.y %o% vec1y), 
                                as.numeric(r1.verticals.start %o% vec1y)),
                          xend = c(rep(as.numeric(vec1x %o% r1.x[2]), each = 16),
                                   rep(as.numeric(vec1x %o% r1.x[2]), each = 8)),
                          yend = c(as.numeric(r1.y %o% vec1y),
                                   as.numeric(r1.verticals.stop %o% vec1y)),
                          Round = c(rep(1, times = 96)))
  
  lineCoords$R2 <- tibble(x = c(rep(as.numeric(vec1x %o% r2.x[1]), each = 8),
                                rep(as.numeric(vec1x %o% r2.x[2]), each = 4)),
                          y = c(as.numeric(r2.y %o% vec1y), 
                                as.numeric(r2.verticals.start %o% vec1y)),
                          xend = c(rep(as.numeric(vec1x %o% r2.x[2]), each = 8),
                                   rep(as.numeric(vec1x %o% r2.x[2]), each = 4)),
                          yend = c(as.numeric(r2.y %o% vec1y),
                                   as.numeric(r2.verticals.stop %o% vec1y)),
                          Round = c(rep(2, times = 48)))
  
  lineCoords$R3 <- tibble(x = c(rep(as.numeric(vec1x %o% r3.x[1]), each = 4),
                                rep(as.numeric(vec1x %o% r3.x[2]), each = 2)),
                          y = c(as.numeric(r3.y %o% vec1y), 
                                as.numeric(r3.verticals.start %o% vec1y)),
                          xend = c(rep(as.numeric(vec1x %o% r3.x[2]), each = 4),
                                   rep(as.numeric(vec1x %o% r3.x[2]), each = 2)),
                          yend = c(as.numeric(r3.y %o% vec1y),
                                   as.numeric(r3.verticals.stop %o% vec1y)),
                          Round = c(rep(3, times = 24)))
  
  lineCoords$R4 <- tibble(x = c(rep(as.numeric(vec1x %o% r4.x[1]), each = 2),
                                rep(as.numeric(vec1x %o% r4.x[2]), each = 1)),
                          y = c(as.numeric(r4.y %o% vec1y), 
                                as.numeric(r4.verticals.start %o% vec1y)),
                          xend = c(rep(as.numeric(vec1x %o% r4.x[2]), each = 2),
                                   rep(as.numeric(vec1x %o% r4.x[2]), each = 1)),
                          yend = c(as.numeric(r4.y %o% vec1y),
                                   as.numeric(r4.verticals.stop %o% vec1y)),
                          Round = c(rep(4, times = 12)))
  
  lineCoords$R5 <- tibble(x = r5.x[rep(c(1, 1, 2), 2)]*rep(vec11, each = 3),
                          y = r5.y*rep(c(1, -1, -1), times = 2),
                          xend = r5.x[2]*rep(vec11, each = 3),
                          yend = r5.y*rep(c(1, -1, 1), times = 2),
                          Round = c(rep(5, times = 6)))
  
  lineCoords$R6 <- tibble(x = r6.x[1]*vec11, 
                          y = r6.y*vec11, 
                          xend = r6.x[2]*vec11, 
                          yend = r6.y*vec11,
                          Round = c(rep(6, times = 2)))
  
  lineCoords$R7 <- tibble(x = mean(r6.x),
                          y = 0,
                          xend = -mean(r6.x),
                          yend = 0,
                          Round = 7)
  
  lineCoords$R0 <- tibble(x = rep(c(r4.x[1], -(2*r4.x[2]-r4.x[1])), each = 2),
                          y = -r1.y[16]*vec1y,
                          xend = rep(c(2*r4.x[2]-r4.x[1], -r4.x[1]), each = 2),
                          yend = -r1.y[16]*vec1y,
                          Round = rep(0, 4))
  
  regions <- c("South", "East", "Midwest", "West")
  
  fullCoords <- bind_rows(lineCoords) %>% 
    dplyr::mutate(Region = case_when(y < 0 & Round == 5 & x == xend ~ "Final",
                                     x < 0 & y > 0 & Round < 6 ~ regions[1],
                                     x < 0 & y < 0 & Round < 6 ~ regions[2],
                                     x > 0 & y > 0 & Round < 6 ~ regions[3],
                                     x > 0 & y < 0 & Round < 6 ~ regions[4],
                                     TRUE ~ "Final"))
  
  # Printing bracket with lines
  empty.bracket <- empty.bracket + 
    geom_segment(data = fullCoords, 
                 color = lineColor, 
                 mapping = aes(x = x, xend = xend, y = y, yend = yend))
  
  if(!is.null(logo)) {
  # Add NCAA logo
  empty.bracket <- empty.bracket + 
    annotation_raster(logo, xmin = mean(r6.x), xmax = -mean(r6.x),
                      ymin = r1.y[13]*1.05, ymax = r1.y[16]*1.05)
  }
  
  # Cleaning up predictions
  preds <- submission %>% 
    mutate(Team1 = as.integer(map_chr(str_split(ID, pattern = "_"), 2)), 
           Team2 = as.integer(map_chr(str_split(ID, pattern = "_"), 3))) %>% 
    dplyr::select(Team1, Team2, Pred)
  
  # Data for drawing bracket
  bracketData <- preds %>% 
    right_join(seeds, by = c("Team1" = "TeamID")) %>% 
    dplyr::rename(Seed1 = Seed, Pred1 = Pred) %>% 
    right_join(seeds, by = c("Team2" = "TeamID", "Season" = "Season")) %>% 
    dplyr::rename(Seed2 = Seed) %>% 
    mutate(Pred2 = 1 - Pred1) %>% 
    dplyr::select(Season, Team1:Pred1, Pred2, Seed1, Seed2) %>% 
    mutate(Region1 = str_sub(Seed1, start = 1, end = 1),
           Region2 = str_sub(Seed2, start = 1, end = 1),
           PlayIn = case_when(str_detect(Seed1, pattern = "a|b") &
                                str_detect(Seed2, pattern = "a|b") &
                                Region1 == Region2 & 
                                str_remove(Seed1, pattern = "a|b") == str_remove(Seed2, pattern = "a|b")~ TRUE,
                              TRUE ~ FALSE),
           Seed1 = as.integer(str_sub(str_remove(Seed1, pattern = "a|b"), start = 2, end = -1)),
           Seed2 = as.integer(str_sub(str_remove(Seed2, pattern = "a|b"), start = 2, end = -1))) %>% 
    mutate(Region1 = case_when(Region1 == "W" ~ regions[2],
                               Region1 == "X" ~ regions[4],
                               Region1 == "Y" ~ regions[3],
                               Region1 == "Z" ~ regions[1]),
           Region2 = case_when(Region2 == "W" ~ regions[2],
                               Region2 == "X" ~ regions[4],
                               Region2 == "Y" ~ regions[3],
                               Region2 == "Z" ~ regions[1])) %>% 
    left_join(teams, by = c("Team1" = "TeamID")) %>% 
    left_join(teams, by = c("Team2" = "TeamID"), suffix = c("1", "2"))
  
  bracketDataFull <- bracketData %>% 
    bind_rows(bracketData %>% 
                rename_with(~ gsub("1", "A", .x, fixed = TRUE), ends_with("1")) %>% 
                rename_with(~ gsub("2", "B", .x, fixed = TRUE), ends_with("2")) %>% 
                rename_with(~ gsub("A", "2", .x, fixed = TRUE), ends_with("A")) %>% 
                rename_with(~ gsub("B", "1", .x, fixed = TRUE), ends_with("B")) %>% 
                dplyr::select(colnames(bracketData)))
  
  # First four play-in games
  firstFour <- bracketDataFull %>% 
    dplyr::filter(PlayIn) %>% 
    dplyr::mutate(Round = 0, 
                  Matchup = as.integer(factor(paste0(ifelse(Team1 < Team2, paste0(Team1, "_", Team2), 
                                                                       paste0(Team2, "_", Team1)))))) %>% 
    dplyr::select(Seed1, Seed2, Region1, Region2, Round, Matchup)
  
  # Possible matchups
  round1 <- data.frame(Seed1 = 1:8, Seed2 = 16:9, 
                       Region1 = rep(c(regions[2], regions[4], regions[3], regions[1]), each = 8)) %>% 
    dplyr::mutate(Region2 = Region1, Round = 1,
                  Matchup = case_when(Seed1 == 1 ~ 1,
                                      Seed1 == 8 ~ 2,
                                      Seed1 == 5 ~ 3,
                                      Seed1 == 4 ~ 4,
                                      Seed1 == 6 ~ 5,
                                      Seed1 == 3 ~ 6,
                                      Seed1 == 7 ~ 7,
                                      Seed1 == 2 ~ 8))
  
  round2 <- map_dfr(.x = rep(list(list(c(1, 16), c(8, 9)), list(c(5, 12), c(4, 13)), 
                                  list(c(6, 11), c(3, 14)), list(c(7, 10), c(2, 15))), 4), 
                    .f = function(x) {expand_grid(Seed1 = x[[1]], Seed2 = x[[2]])}) %>%  
    mutate(Region1 = rep(c(regions[2], regions[4], regions[3], regions[1]), each = 16)) %>% 
    mutate(Region2 = Region1, Round = 2,
           Matchup = case_when(Seed1 %in% c(1, 16) ~ 1,
                               Seed1 %in% c(5, 12) ~ 2,
                               Seed1 %in% c(6, 11) ~ 3,
                               Seed1 %in% c(7, 10) ~ 4))
  
  round3 <- expand_grid(Seed1 = c(1, 16, 8, 9), Seed2 = c(5, 12, 4, 13), 
                        Region1 = c(regions[2], regions[4], regions[3], regions[1])) %>%
    bind_rows(expand_grid(Seed1 = c(6, 11, 3, 14), Seed2 = c(7, 10, 2, 15), 
                          Region1 = c(regions[2], regions[4], regions[3], regions[1]))) %>% 
    dplyr::mutate(Region2 = Region1, Round = 3, Matchup = rep(1:2, each = 64))
  
  round4 <- expand_grid(Seed1 = c(1, 16, 8, 9, 5, 12, 4, 13), 
                        Seed2 = c(6, 11, 3, 14, 7, 10, 2, 15), 
                        Region1 = c(regions[2], regions[4], regions[3], regions[1])) %>% 
    dplyr::mutate(Region2 = Region1, Round = 4, Matchup = rep(1:2, each = 128))
  
  round5 <- expand_grid(Seed1 = 1:16, Seed2 = 1:16, Region1 = c(regions[4], regions[1])) %>% 
    dplyr::mutate(Region2 = ifelse(Region1 == regions[4], regions[2], regions[3]), Round = 5, 
                  Matchup = rep(1:2, each = 256))
  
  round6 <- expand_grid(Seed1 = 1:16, Seed2 = 1:16, Region1 = c(regions[4], regions[2]),
                        Region2 = c(regions[1], regions[3])) %>% 
    dplyr::mutate(Round = 6, Matchup = 1)
  
  roundsWide <- bind_rows(firstFour, round1, round2, round3, 
                          round4, round5, round6) %>% 
    left_join(bracketDataFull %>% 
                dplyr::select(-Season, -Team1, -Team2),
              relationship = "many-to-many")
  
  roundsLong <- roundsWide %>% 
    pivot_longer(cols = c(Seed1, Seed2), 
                 names_to = "Team", values_to = "Seed") %>% 
    dplyr::mutate(Region1 = fct_relevel(Region1, regions[4], regions[2], 
                                                 regions[1], regions[3]),
                  Region2 = fct_relevel(Region2, regions[4], regions[2], 
                                                 regions[1], regions[3])) %>% 
    arrange(Round, Region1, Matchup, Team, Seed) %>% 
    dplyr::mutate(Pred1 = sprintf('%.3f',Pred1), Pred2 = sprintf('%.3f',Pred2),
                  Winner = ifelse(Pred1 > Pred2, TeamName1, TeamName2), 
                  TeamName = case_when(
                  Team == "Seed1" & PlayIn ~ paste0(paste0("(", Pred1, ") ", TeamName1, " ", Seed),
                                                      " vs. ", paste0(Seed, " ", TeamName2, " (", Pred2, ")")),
                  Team == "Seed2" & PlayIn ~ paste0(paste0("(", Pred2, ") ", TeamName2, " ", Seed),
                                                      " vs. ", paste0(Seed, " ", TeamName1, " (", Pred1, ")")),
                  Team == "Seed1" & Region1 %in% c(regions[4], regions[2]) ~ paste0(Seed, " ", TeamName1, " (", Pred1, ")"),
                  Team == "Seed2" & Region2 %in% c(regions[4], regions[2]) ~ paste0(Seed, " ", TeamName2, " (", Pred2, ")"),
                  Team == "Seed1" & Region1 %in% c(regions[1], regions[3]) ~ paste0("(", Pred1, ") ", TeamName1, " ", Seed),
                  Team == "Seed2" & Region2 %in% c(regions[1], regions[3]) ~ paste0("(", Pred2, ") ", TeamName2, " ", Seed)))
  
  # Printing first four play-in games
  r0Labs <- roundsLong %>% 
    dplyr::filter(Round == 0) %>% 
    dplyr::arrange(Matchup) %>% 
    group_by(Matchup) %>% 
    dplyr::slice(1) %>% 
    ungroup() %>% 
    dplyr::mutate(Xstart = c(r4.x[1], r4.x[1], 
                      -(2*r4.x[2]-r4.x[1]), 
                      -(2*r4.x[2]-r4.x[1])),
                  Y = c(r1.y[16], -r1.y[16], 
                        r1.y[16], -r1.y[16]))
  
  # Winners from first four play-in games
  r0Winners <- roundsLong %>% 
    dplyr::filter(Round == 0) %>% 
    dplyr::arrange(Matchup) %>% 
    group_by(Matchup) %>% 
    dplyr::slice(1) %>% 
    ungroup() %>% 
    pull(Winner) %>% 
    unique()
  
  playins <- roundsLong %>% 
    dplyr::filter(Round == 0) %>% 
    dplyr::arrange(Matchup) %>% 
    group_by(Matchup) %>% 
    dplyr::slice(1) %>% 
    ungroup() %>% 
    dplyr::select(TeamName1:TeamName2) %>% 
    unlist()
  
  r0Losers <- playins[which(!(playins %in% r0Winners))]
  
  # Printing round 1 teams
  r1Labs <- roundsLong %>% 
    dplyr::filter(Round == 1, !(TeamName1 %in% r0Losers), 
                              !(TeamName2 %in% r0Losers)) %>% 
    dplyr::mutate(Xstart = c(rep(r1.x[1], 16), rep(r1.x[1], 16),
                      rep(-r1.x[2], 16), rep(-r1.x[2], 16)),
                  Y = c(rep(c(rev(r1.y), r1.y), 2)*rep(c(1, -1), each = 16))+0.001)
  
  # Winners from round 1
  r1Winners <- roundsLong %>% 
    dplyr::filter(Round == 1, !(TeamName1 %in% r0Losers), 
                              !(TeamName2 %in% r0Losers)) %>% 
    pull(Winner) %>% 
    unique()
  
  # Printing round 2 teams
  r2Labs <- roundsLong %>% 
    dplyr::filter(Round == 2, TeamName1 %in% r1Winners, 
                              TeamName2 %in% r1Winners) %>% 
    dplyr::distinct() %>% 
    dplyr::mutate(Xstart = c(rep(r2.x[1], 8), rep(r2.x[1], 8),
                             rep(-r2.x[2], 8), rep(-r2.x[2], 8)),
                  Y = c(rev(r2.y), -r2.y, rev(r2.y), -r2.y))
  
  # Winners from round 2
  r2Winners <- roundsLong %>% 
    dplyr::filter(Round == 2, TeamName1 %in% r1Winners, 
                              TeamName2 %in% r1Winners) %>% 
    dplyr::distinct() %>%
    dplyr::pull(Winner) %>% 
    unique()
  
  # Printing round 3 teams
  r3Labs <- roundsLong %>% 
    dplyr::filter(Round == 3, TeamName1 %in% r2Winners, 
                              TeamName2 %in% r2Winners) %>% distinct() %>% 
    dplyr::mutate(Xstart = c(rep(r3.x[1], 4), rep(r3.x[1], 4),
                             rep(-r3.x[2], 4), rep(-r3.x[2], 4)),
                  Y = c(rev(r3.y), -r3.y, rev(r3.y), -r3.y))
  
  # Winners from round 3
  r3Winners <- roundsLong %>% 
    dplyr::filter(Round == 3, TeamName1 %in% r2Winners, 
                              TeamName2 %in% r2Winners) %>% 
    dplyr::distinct() %>%
    dplyr::pull(Winner) %>% 
    unique()
  
  # Printing round 4 teams
  r4Labs <- roundsLong %>% 
    dplyr::filter(Round == 4, TeamName1 %in% r3Winners, 
                              TeamName2 %in% r3Winners) %>% 
    dplyr::distinct() %>% 
    dplyr::mutate(Xstart = c(rep(r4.x[1], 2), rep(r4.x[1], 2),
                             rep(-r4.x[2], 2), rep(-r4.x[2], 2)),
                  Y = c(rev(r4.y), -r4.y, rev(r4.y), -r4.y))
  
  # Winners from round 4
  r4Winners <- roundsLong %>% 
    dplyr::filter(Round == 4, TeamName1 %in% r3Winners, 
                              TeamName2 %in% r3Winners) %>% 
    dplyr::distinct() %>%
    pull(Winner) %>% 
    unique()
  
  # Printing round 5 teams
  r5Labs <- roundsLong %>% 
    dplyr::filter(Round == 5, TeamName1 %in% r4Winners, 
                              TeamName2 %in% r4Winners) %>% 
    dplyr::distinct() %>% 
    mutate(Xstart = c(rep(r5.x[1], 1), rep(r5.x[1], 1),
                      rep(-r5.x[2], 1), rep(-r5.x[2], 1)),
           Y = c(rev(r5.y), -r5.y, rev(r5.y), -r5.y))
  
  # Winners from round 5
  r5Winners <- roundsLong %>% 
    dplyr::filter(Round == 5, TeamName1 %in% r4Winners, 
                              TeamName2 %in% r4Winners) %>% 
    dplyr::distinct() %>%
    pull(Winner) %>% 
    unique()
  
  # Printing round 6 teams
  r6Labs <- roundsLong %>% 
    dplyr::filter(Round == 6, TeamName1 %in% r5Winners, 
                              TeamName2 %in% r5Winners) %>% 
    dplyr::distinct() %>% 
    mutate(Xstart = c(rep(r6.x[1], 1), rep(-r6.x[2], 1)),
           Y = c(r6.y, -r6.y))
  
  # Winners from round 6 (grand overall winner)
  r6Winner <- roundsLong %>% 
    dplyr::filter(Round == 6, TeamName1 %in% r5Winners, 
                              TeamName2 %in% r5Winners) %>% 
    dplyr::distinct() %>%
    pull(Winner) %>% 
    unique()
  
  r7Labs <- dplyr::slice_head(r6Labs, n = 1) %>% 
    dplyr::mutate(Region1 = "Championship", Region2 = "Championship", Round = 7,
                  Xstart = 0 - nchar(r6Winner) / 10, Y = 0, TeamName = r6Winner)
  
  # Printing filled out bracket
  sizeParam <- 3
  labData <- bind_rows(r0Labs, r1Labs, r2Labs, r3Labs, 
                       r4Labs, r5Labs, r6Labs, r7Labs)
  
  bracketGG <- empty.bracket +
    geom_text(data = labData, aes(x = Xstart, y = Y,
                               label = TeamName, text = TeamName),
              size = rel(textSize), hjust = 0, vjust = 0,
              family = fontFamily) +
    theme(text = element_text(family = fontFamily,
                              size = rel(textSize)))
  
  # Creating data for reactable table
  ret <- bracketData %>%
    dplyr::mutate(Pred1 = as.numeric(Pred1),
                  Pred2 = as.numeric(Pred2)) %>% 
    dplyr::mutate(SeedFav = ifelse(Pred1 > Pred2, Seed1, Seed2),
                  Favorite = ifelse(Pred1 > Pred2, 
                                    TeamName1, TeamName2), 
                  SeedDog = ifelse(Pred1 < Pred2, Seed1, Seed2),
                  Underdog = ifelse(Pred1 < Pred2, 
                                    TeamName1, TeamName2),
                  `Favorite Win Probability` = as.numeric(ifelse(Pred1 > Pred2, Pred1, Pred2))) %>% 
    dplyr::select(SeedFav, Favorite, SeedDog, Underdog, `Favorite Win Probability`)
  
  if(retData) {
    return(list(bracketGG = bracketGG, ret = ret))
  } else {
    return(bracketGG)
  }
  
  return(list(bracketGG = bracketGG, ret = ret))
}

# Function for creating reactable table
# Following example at: https://kcuilla.github.io/reactablefmtr/articles/themes.html
reactableFun <- function(myData, gradColors = c("#ffa241", "white", "#065cb5")) {
  myData %>% 
  reactable(showSortIcon = FALSE,
          searchable = TRUE,
          filterable = TRUE,
          language = reactableLang(
            searchPlaceholder = "Search for a matchup...",
            pageInfo = "{rowStart}\u2013{rowEnd} of {rows} matchups",
            noData = "That matchup does not exist."),
            defaultColDef = colDef(
              maxWidth = 65,
              style = color_scales(myData, colors = gradColors),
              filterable = FALSE
            ),
          columns = list(
              SeedFav = colDef(
                name = "Seed",
              maxWidth = 65,
              style = color_scales(myData, colors = gradColors),
              filterable = TRUE
            ),
              Favorite = colDef(maxWidth = 300, filterable = TRUE, rowHeader = TRUE, sticky = "left"),
              SeedDog = colDef(
                name = "Seed",
              maxWidth = 65,
              style = color_scales(myData, colors = gradColors),
              filterable = TRUE
            ),
              Underdog = colDef(maxWidth = 300, filterable = TRUE, rowHeader = TRUE, sticky = "left"),
            `Favorite Win Probability` = colDef(
              name = "Favorite Win Probability",
              filterable = FALSE,
              maxWidth = 300,
              align = "center",
              cell = data_bars(
                myData,
                fill_color = rev(gradColors),
                number_fmt = scales::label_number(accuracy = 0.001)
              ),
              style = list(borderLeft = "1px solid rgba(0, 0, 0, 0.3)")
            )
          ),
defaultPageSize = 40) %>% 
  add_title(title = "Model data source: Kaggle", font_size = 10) %>% 
  google_font(font_family = str_to_title(fontFamily))
}

# lineColor = "black"; fontFamily = "Passion One"; textSize = 6; retData = FALSE; seeds = mySeeds; submission = nnetSubmissionAwin; teams = myTeams; textSize = 4; retData = TRUE; logo = myLogo

# Inputs for drawing bracket
seedsPath <- paste0(stageDir, ifelse(womens, "W", "M"), "NCAATourneySeeds.csv")
mySeeds <- read_csv(paste0(seedsPath)) %>% 
  filter(Season == tourneyYear)

teamsPath <- paste0(stageDir, ifelse(womens, "W", "M"), "Teams.csv")

myTeams <- read_csv(teamsPath) %>% 
  select(TeamID:TeamName)

myLogo <- png::readPNG("../2022/March_Madness_logo.png")

# Drawing bracket
nnetSubmissionAwin <- readr::read_csv(paste0("Preds/", "Awin", "/preds_nnet_", 
                                         ifelse(womens, "W", "M"), "_", "Awin", "_only.csv"))

# Drawing bracket
nnetSubmissionMOV <- readr::read_csv(paste0("Preds/", "MOV", "/preds_nnet_", 
                                         ifelse(womens, "W", "M"), "_", "MOV", "_only.csv"))

bracketResAwin <- bracketDraw(submission = nnetSubmissionAwin, 
            seeds = mySeeds, teams = myTeams, textSize = 4,
            retData = TRUE)

bracketResMOV <- bracketDraw(submission = nnetSubmissionMOV, 
            seeds = mySeeds, teams = myTeams,
            retData = TRUE)
```

Row {.tabset .tabset-fade data-height=700}
-----------------------------------------------------------------------

### Bracket: Binary Outcome Model

```{r, fig.width = 14, fig.height= 7}
plotly::ggplotly(bracketResAwin$bracketGG, tooltip = "text")
```

### Bracket: Margin of Victory Model

```{r, fig.width = 14, fig.height= 7}
bracketResMOV$bracketGG
```


Row {.tabset .tabset-fade data-height=300}
-----------------------------------------------------------------------

### Matchups: Binary Outcome Model

```{r, eval = TRUE, include = TRUE}
reactableFun(myData = bracketResAwin$ret %>% drop_na())
```

### Matchups: Margin of Victory Model

```{r, eval = TRUE, include = TRUE}
# Following example at: https://kcuilla.github.io/reactablefmtr/articles/themes.html
reactableFun(myData = bracketResMOV$ret %>% drop_na())
```

### Team Ratings: Binary Outcome Model

```{r}
# Function for creating table of team ranks
rankFun <- function(myData, gradColors = c("#ffa241", "white", "#065cb5")) {
  myData <- bind_rows(myData %>% 
  dplyr::mutate(Team = Favorite, 
                Prob = `Favorite Win Probability`) %>% 
  dplyr::select(Team, Prob),
 bracketResAwin$ret %>% 
  dplyr::mutate(Team = Underdog, 
                Prob = 1 - `Favorite Win Probability`) %>% 
  dplyr::select(Team, Prob)) %>% 
  group_by(Team) %>% 
  dplyr::summarize(Rating = sum(Prob)) %>% 
  ungroup() %>% 
  dplyr::mutate(Rank = rank(-Rating), 
                Rating = as.numeric(scale(Rating, center = TRUE, scale = TRUE))) %>% 
  dplyr::arrange(Rank) %>% 
  dplyr::select(Rank, Team, Rating) 
  
  myData %>% 
  reactable(showSortIcon = FALSE,
          searchable = TRUE,
          filterable = TRUE,
          language = reactableLang(
            searchPlaceholder = "Search for a team...",
            pageInfo = "{rowStart}\u2013{rowEnd} of {rows} teams",
            noData = "That team does not exist."),
            defaultColDef = colDef(
              maxWidth = 65,
              style = color_scales(myData, colors = gradColors),
              filterable = FALSE
            ),
          columns = list(
              Rank = colDef(
              maxWidth = 65,
              style = color_scales(myData, colors = gradColors),
              filterable = TRUE
            ),
              Team = colDef(maxWidth = 300, filterable = TRUE, rowHeader = TRUE, sticky = "left"),
            Rating = colDef(
              filterable = FALSE,
              maxWidth = 300,
              align = "center",
              cell = data_bars(
                myData,
                fill_color = rev(gradColors),
                number_fmt = scales::label_number(accuracy = 0.01)
              ),
              style = list(borderLeft = "1px solid rgba(0, 0, 0, 0.3)")
            )
          ),
defaultPageSize = 40) %>% 
  add_title(title = "Team ratings are standardized win probabilities summed across all possible matchups of all NCAA teams.", font_size = 10) %>% 
  google_font(font_family = str_to_title(fontFamily))
}
```

```{r}
rankFun(myData = bracketResAwin$ret)
```

### Team Ratings: Margin of Victory Model

```{r}
rankFun(myData = bracketResMOV$ret)
```
